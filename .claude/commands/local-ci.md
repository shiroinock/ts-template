---
description: remote CI (GitHub Actions) 相当のチェックをローカルで実行。Biome check、テスト、ビルドを並列実行し、全てのチェックが成功したことを確認する。PR作成前の事前チェックに使用。
---

# Local CI コマンド

**このコマンドの役割**: remote CI (GitHub Actions) 相当のチェックを**ローカルマシン上**で実行するコマンド。

## check-remote-ci コマンドとの違い

| コマンド | 実行場所 | 目的 | 使用場面 |
|---------|---------|------|----------|
| **local-ci** (このコマンド) | **local** | local CI チェック（remote CI 相当）をローカル実行 | PR作成前の事前チェック、TDD完了後の検証 |
| **check-remote-ci** | **remote** (GitHub Actions) | remote CI の実行状態確認と修正方針提案 | PR作成後、remote CI が失敗した際の調査 |

## 目的

プルリクエスト作成前に**ローカルマシン上**で実行することで、remote CI の失敗を事前に検出します。
`.github/workflows/ci.yml` と同じチェックを並列実行し、全ての問題を一度に検出します。

## 実行内容

以下の3つのチェックを**並列**実行します：

### 1. Biome Check
- **実行**: `biome-check` sub agent
- **目的**: コードスタイル、リント、フォーマットのチェック
- **タイムアウト**: 2分
- **失敗時の対応**: エラー内容を表示し、`pnpm lint:fix` で自動修正可能な旨を伝える

### 2. Test
- **実行**: `test-check` sub agent
- **目的**: 全テストスイートの実行
- **タイムアウト**: 5分
- **失敗時の対応**: テストエラーを表示

### 3. Build
- **実行**: `build-check` sub agent
- **目的**: TypeScriptコンパイル + Viteビルド
- **タイムアウト**: 3分
- **失敗時の対応**: 型エラーやビルドエラーを表示

**並列実行の利点**:
- 全ての失敗要因を一度に検出できる
- 複数の問題を同時に修正可能
- 再実行の回数を削減し、開発効率を向上

### remote CI (GitHub Actions) との違い

**含まれていないチェック**:
- **Security Audit** (`npm audit`, `secretlint`)
  - **除外理由**:
    - セキュリティチェックは依存関係の脆弱性を検出するため、コード変更のたびに実行する必要性は低い
    - 実行時間は通常30秒以内と高速だが、頻繁に実行する価値は低い
    - 脆弱性は依存関係のアップデート時に主に発生し、コード変更では影響を受けない
  - **remote CI (GitHub Actions) での実行**:
    - すべての PR で自動的に実行されます
    - security-audit ジョブとして独立して実行され、失敗時は PR マージがブロックされます
  - **ローカルでの手動実行**（必要に応じて）:
    ```bash
    pnpm audit --audit-level=moderate
    pnpm run secretlint
    ```

**設計方針**:
- **local-ci**: PR作成前の基本的な品質チェック（Biome、Test、Build）に焦点
- **remote CI (GitHub Actions)**: 包括的なチェック（セキュリティ、依存関係の更新など）を含む完全な検証

## 実装手順

### Step 1: 開始メッセージ

```
🔍 Running local CI checks (in parallel)...
```

### Step 2: 3つの sub agent を並列起動

**重要**: **単一のメッセージで**3つの sub agent を並列起動します：

```javascript
// Task 1: biome-check
Task({
  "subagent_type": "biome-check",
  "model": "haiku",
  "description": "Run Biome check",
  "prompt": "pnpm lint を実行し、結果を報告してください。"
})

// Task 2: test-check
Task({
  "subagent_type": "test-check",
  "model": "haiku",
  "description": "Run tests",
  "prompt": "pnpm test を実行し、結果を報告してください。"
})

// Task 3: build-check
Task({
  "subagent_type": "build-check",
  "model": "haiku",
  "description": "Run build",
  "prompt": "pnpm build を実行し、結果を報告してください。"
})
```

**注意**: これら3つのTask呼び出しを1つのメッセージで実行することで、真の並列実行が実現されます。

### Step 3: 結果の集計

**TaskOutput ツールを使用して各 sub agent の出力を取得します**：

並列実行された sub agent の出力は、TaskOutput ツールを使用して個別に取得します。これにより、出力の混在を防ぎ、各チェックの結果を明確に分離できます。

**出力のパース**:

各 sub agent の出力をJSON形式でパースし、構造化されたデータを取得します。

**結果の判定**:

各 sub agent の結果を確認し、成功・失敗を記録します：

- **Biome check**:
  - ✅ 成功: `biomeData.status === "PASSED"` → `Biome check: ✓`
  - ❌ 失敗: `biomeData.status === "FAILED"` → `Biome check: ✗` + エラー内容

- **Test**:
  - ✅ 成功: `testData.status === "PASSED"` → `Tests: ✓ (${testData.details.tests.total} tests passed)`
  - ❌ 失敗: `testData.status === "FAILED"` → `Tests: ✗` + エラー内容

- **Build**:
  - ✅ 成功: `buildData.status === "PASSED"` → `Build: ✓`
  - ❌ 失敗: `buildData.status === "FAILED"` → `Build: ✗` + エラー内容

**出力順序の保証**:

Sub agent は並列実行されるため完了順序は不定ですが、TaskOutput で取得後に常に **Biome → Test → Build** の順序で表示します。これにより、ユーザーは一貫した形式で結果を確認できます。

### JSON パースエラー時の対応（フォールバック機構）

Sub agent（biome-check、test-check、build-check）は構造化されたJSON形式で出力することが期待されますが、予期しないエラーやモデルの制限により、JSON形式でない出力が返される可能性があります。

**JSONパースエラーの検出**:

```javascript
let biomeData;
try {
  biomeData = JSON.parse(biomeResult.output);
} catch (error) {
  // JSON パースエラー: フォールバック処理
  biomeData = parseFallback(biomeResult.output, "biome");
}
```

**フォールバック処理**:

JSON形式でない場合、以下の手順でプレーンテキスト出力を解析します：

1. **ステータスの判定**:
   - 出力に "PASSED" または "✓" または "success" が含まれる → `status: "PASSED"`
   - 出力に "FAILED" または "✗" または "error" が含まれる → `status: "FAILED"`
   - いずれも含まれない → `status: "FAILED"`（安全側に倒す）

2. **エラーメッセージの抽出**:
   - 出力全体を `errors` 配列の1要素として含める
   - ファイル名や行番号が含まれている場合、可能な範囲で抽出

3. **警告メッセージの表示**:
   ```
   ⚠️  Warning: Subagent output format is invalid (expected JSON)
   Check: biome-check
   Falling back to plain text parsing. Result accuracy may be reduced.
   ```

### Step 4: サマリー表示

**全て成功した場合**:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Local CI Checks Complete
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

| Check       | Result | Details                                      |
|-------------|--------|----------------------------------------------|
| Biome check | ✓      | No issues found                              |
| Tests       | ✓      | X tests passed                               |
| Build       | ✓      | Build completed successfully                 |

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ All local CI checks passed!

🎉 Ready to create a pull request!
```

**1つ以上失敗した場合（部分的失敗を含む）**:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Local CI Checks Complete
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

| Check       | Result | Details                                      |
|-------------|--------|----------------------------------------------|
| Biome check | ✓/✗    | 簡潔な説明（1行）                              |
| Tests       | ✓/✗    | 簡潔な説明（1行）                              |
| Build       | ✓/✗    | 簡潔な説明（1行）                              |

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## Biome Check Failures [失敗時のみ]

[詳細なエラー情報、最大10件]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## Test Failures [失敗時のみ]

[詳細なエラー情報、最大10件]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## Build Failures [失敗時のみ]

[詳細なエラー情報、最大10件]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## Next Steps [失敗時のみ]

1. 最優先の修正項目（具体的なコマンドまたは手順）
2. 次の修正項目
...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

❌ Local CI checks failed

Fix the issues above and re-run the checks.
```

## エラーハンドリング

3つの sub agent が並列実行されるため、全ての sub agent の完了を待ち、失敗したチェックを全て表示します：

1. **biome-check失敗**:
   - エラー内容を表示
   - `pnpm lint:fix` で自動修正可能な旨を伝える

2. **test-check失敗**:
   - テストエラーを表示
   - どのテストが失敗したかを明示

3. **build-check失敗**:
   - 型エラーやビルドエラーを表示

4. **複数の sub agent が失敗**:
   - 全ての失敗内容をまとめて表示
   - 各チェックの修正方法を提示
   - ユーザーが全ての問題を同時に修正できるようにする

## 並列実行の安全性

3つのチェック（Biome、Test、Build）は並列実行されますが、以下の理由により安全です：

### 読み取り専用操作
全てのチェックは**読み取り専用**の操作です：
- **Biome check**: コードを読み取り、スタイル違反を検出（ファイル変更なし）
- **Test**: テストコードを実行（node_modules、dist は変更されない）
- **Build**: TypeScript をコンパイルして dist/ に出力（他のチェックと独立）

### ファイルシステムの競合
以下の共有リソースへの同時アクセスは問題ありません：
- **pnpm-lock.yaml**: 読み取りのみ
- **node_modules**: インストール済み、読み取りのみ
- **dist ディレクトリ**: Build のみが書き込み（他は読み取らない）

### 検証済みの安全性
- remote CI (GitHub Actions) でも同様の並列実行を行っており、問題は発生していません
- Vitest、TypeScript、Biome は全て並列実行に対応した設計になっています

## 注意事項

- remote CI と完全に同じ環境ではないため、local CI で成功しても remote CI で失敗する可能性はある
- ただし、ほとんどの問題は事前に検出できる
- 実行時間は環境によって異なるが、通常3-5分程度
- **3つの sub agent を必ず並列実行する**（単一メッセージで3つのTask呼び出し）
- 全ての sub agent の完了を待ってからサマリーを表示する
- 複数のチェックが失敗した場合、全ての問題を一度に確認できる
- `pnpm install` は実行しない（依存関係は既にインストール済みと仮定）

## 重要な実装上の注意事項

### このコマンドの責務を正しく理解する

**このコマンドは検索や調査を行うコマンドではありません。** CIチェックを実行するコマンドです。

1. **検索・調査は行わない**
   - ファイルの検索や読み取りは不要です
   - コードベースの理解や分析も不要です
   - 純粋にCIチェックの実行に集中してください

2. **コードの自動修正は絶対に行わない**
   - このコマンドは**検出のみ**を行います
   - Biome check が失敗しても `pnpm lint:fix` を**実行しないでください**
   - 複雑性エラー（cognitive complexity）が検出されても**リファクタリングしないでください**
   - コードの修正、コミット、プッシュは**全て禁止**です
   - 問題を検出したら、**報告のみ**を行い、修正はユーザーに任せてください
   - 例外: 一切なし。どのような問題でも自動修正は禁止です

3. **必須の実行手順**
   - Step 1: 開始メッセージを表示
   - Step 2: 3つの sub agent を**必ず**並列起動
   - Step 3: 全ての sub agent の完了を待機
   - Step 4: 結果を集計してサマリーを表示

4. **Sub agent の起動は必須**
   - biome-check、test-check、build-check の3つを**必ず**起動してください
   - これらを起動しない場合、CIチェックは実行されません
   - 「準備ができた」と言うだけでは何も実行されません

## 結果報告の統一フォーマット

### 推奨される出力構造

以下の順序で出力してください（サマリーファースト方式）:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Local CI Checks Complete
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

| Check       | Result    | Details                                      |
|-------------|-----------|----------------------------------------------|
| Biome check | ✓/✗       | 簡潔な説明（1行）                              |
| Tests       | ✓/✗       | 簡潔な説明（1行）                              |
| Build       | ✓/✗       | 簡潔な説明（1行）                              |

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## Biome Check Failures [失敗時のみ]

[詳細なエラー情報、最大10件]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## Test Failures [失敗時のみ]

[詳細なエラー情報、最大10件]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## Build Failures [失敗時のみ]

[詳細なエラー情報、最大10件]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## Next Steps [失敗時のみ]

1. 最優先の修正項目（具体的なコマンドまたは手順）
2. 次の修正項目
...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 重要な注意事項

- **横線は必ず100文字に統一**してください
- サマリー表は**必ず最初**に表示してください
- 詳細セクションは、サマリー表の**後**に表示してください
- 出力が長くなりすぎる場合、詳細を省略してでもサマリーと次のステップを優先してください

## 使い方

```bash
/local-ci
```

このコマンドを実行すると、Claude が上記の手順を実行します（3つのチェックは並列実行されます）。

## 他のコマンドとの違い

詳細な比較は冒頭の表を参照してください。

- **`/local-ci`** (このコマンド): local CI チェック（remote CI 相当）を**ローカルマシン上**で実行（Biome check、テスト、ビルド）
- **`/check-remote-ci`**: **remote CI (GitHub Actions)** の実行状態を確認して修正方針を提案
