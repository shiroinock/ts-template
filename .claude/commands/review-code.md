# コードレビュー＆自動修正ループ

ファイル×観点のマトリクス方式でレビューを実行し、修正 → 再レビューのループを行ってください。

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│  Step 1: ファイル分類 (classify-files)                      │
│  - src/ 内のファイルを列挙                                   │
│  - 各ファイルの性質を判定                                    │
│  - ファイル×観点のマトリクスを生成                          │
└─────────────────┬───────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────────────┐
│  Step 2: 個別レビュー (review-file × N並列)                 │
│  - 各ファイルを指定された観点でレビュー                      │
│  - 1ファイル × 1観点 = 1エージェント呼び出し                │
└─────────────────┬───────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────────────┐
│  Step 3: 修正計画 (plan-fix)                                │
│  - レビュー結果を分析                                       │
│  - should_fix: false → ループ終了                          │
└─────────────────┬───────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────────────┐
│  Step 4: 修正実行 (implement)                               │
│  - 修正計画に基づいてコードを修正                            │
└─────────────────┬───────────────────────────────────────────┘
                  ↓
        Step 2に戻る（最大3回）
```

## エージェント役割分担

| エージェント | モデル | 役割 |
|-------------|--------|------|
| **classify-files** | haiku | ファイルを分析し、適用すべき観点をマッピング |
| **review-file** | haiku | 1ファイル×1観点のレビューを実行 |
| **plan-fix** | opus | レビュー結果を分析し修正計画を立案 |
| **implement** | sonnet | 修正計画に基づいてコードを修正 |

## 手順

### Step 1: ファイル分類

1. `classify-files` サブエージェント（subagent_type: classify-files）を起動
2. **レビュー対象**: gitのdiffに含まれる全ファイル（src/以外も含む）
   - `git diff --name-only HEAD` + `git ls-files --others --exclude-standard`
   - 除外: `.gitkeep`, `node_modules/`, `dist/`, `.claude/reports/`
3. 出力されるマトリクスを保存：
   ```json
   {
     "files": [...],
     "matrix": {
       "typescript": ["file1.ts", "file2.tsx"],
       "test-quality": ["file1.test.ts"],
       "react-component": ["file2.tsx"]
     },
     "uncovered_files": [...],
     "suggested_aspects": [...]
   }
   ```

### Step 2: 個別レビュー

1. マトリクスの各組み合わせに対して `review-file` サブエージェントを**並列起動**
   ```
   プロンプト例:
   以下のファイルを指定された観点でレビューしてください。

   対象ファイル: src/utils/helpers.ts
   レビュー観点: .claude/review-points/typescript.md
   ```
2. 各レビュー結果を収集
3. 結果をマトリクス形式で整理：
   ```
   | ファイル | typescript | test-quality | react-component |
   |----------|------------|--------------|-----------------|
   | file1.ts | PASS       | -            | -               |
   | file2.tsx| WARN       | -            | PASS            |
   ```

### Step 3: 修正計画

1. `plan-fix` サブエージェント（subagent_type: plan-fix）を起動
   ```
   プロンプト例:
   以下のレビュー結果を分析し、修正計画を立案してください。

   [レビュー結果マトリクス]
   [各issueの詳細]
   ```
2. `should_fix: false` なら終了

### Step 4: 修正実行

1. `implement` サブエージェント（subagent_type: implement）を起動
2. 修正内容を記録
3. Step 2に戻る

## 並列実行の最適化

- レビューは1ファイル×1観点単位で最大並列実行
- 例：3ファイル×2観点 = 6並列実行
- ただし、同時実行数が多すぎる場合は適宜バッチ化

## レポート出力

`.claude/reports/review_YYYYMMDD_HHMMSS.md` に保存：

```markdown
# コードレビュー＆自動修正結果

- **実行日時**: YYYY-MM-DD HH:MM:SS
- **ループ回数**: X回
- **最終結果**: PASS / WARN残存 / FAIL残存
- **レビュー対象ファイル数**: X件

## ファイル×観点マトリクス

| ファイル | TypeScript | テスト品質 | React |
|----------|------------|-----------|-------|
| src/utils/helpers.ts | PASS | - | - |
| src/components/Button.tsx | PASS | - | PASS |
| vite.config.ts | PASS | - | - |

## カバーされなかったファイル

以下のファイルは既存の観点では十分にカバーできませんでした：

| ファイル | 理由 |
|----------|------|
| package.json | 設定ファイル（適用可能な観点なし） |

## 観点追加のサジェスト

以下の新しいレビュー観点の追加を検討してください：

### 1. config-validation（設定ファイル検証）
- **理由**: 設定ファイルが複数変更されているが、既存観点ではカバーできない
- **対象ファイル**: `vite.config.ts`, `tsconfig.json`, `package.json`
- **提案チェック項目**:
  - [ ] 必須フィールドが設定されているか
  - [ ] パスの整合性が取れているか
  - [ ] ビルド設定が正しいか

## 修正履歴

### ループ 1
**検出された問題**:
- src/utils/helpers.ts:42 [typescript] 変数名が不明確

**修正内容**:
- `x` → `inputValue` にリネーム

## 残存する問題
- [ ] [問題 - 理由]
```

## 終了条件

1. 全てのファイル×観点の組み合わせでPASS
2. plan-fixが `should_fix: false` を返した
3. 3回のループ完了

## 観点ファイル

観点ファイルは `.claude/review-points/` に格納：
- `typescript.md` - TypeScript型安全性
- `test-quality.md` - テスト品質
- `react-component.md` - Reactコンポーネント
- `project-structure.md` - プロジェクト構造

各観点ファイルには「適用条件」セクションがあり、どのファイルに適用すべきかが定義されています。
